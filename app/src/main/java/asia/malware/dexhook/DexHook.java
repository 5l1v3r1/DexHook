package asia.malware.dexhook;

import android.util.Log;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.UUID;


import de.robv.android.xposed.IXposedHookLoadPackage;
import de.robv.android.xposed.XC_MethodHook;
import de.robv.android.xposed.XSharedPreferences;
import de.robv.android.xposed.XposedBridge;
import de.robv.android.xposed.callbacks.XC_LoadPackage;

import static de.robv.android.xposed.XposedHelpers.findAndHookConstructor;
import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;

/**
 * Created by jcase on 9/7/15.
 */
public class DexHook implements IXposedHookLoadPackage {




    //set this to target a specific package only
    XSharedPreferences pref = new XSharedPreferences("asia.malware.dexhook", "dexhook_sp");
    String targetPackage = pref.getString("package_name", "");
    String packageName = null;

    String baseDir = pref.getString("dir_path", "/data/local/tmp/dumps");

    @Override
    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam lpparam) throws Throwable {


        packageName = lpparam.packageName;

        if (!targetPackage.isEmpty() && !targetPackage.equals(packageName)) {
            return;
        }


        findAndHookConstructor("dalvik.system.BaseDexClassLoader", lpparam.classLoader, String.class, File.class, String.class, ClassLoader.class, new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                String outDir = baseDir;
                String dexPath = (String) param.args[0];

                //Ignore loading of files from /system, comment this out if you wish
                if (dexPath.startsWith("/system/"))
                    return;

                XposedBridge.log("Hooking dalvik.system.BaseDexClassLoader for " + packageName);
                String uniq = UUID.randomUUID().toString();
                outDir = outDir + "/" + packageName  + dexPath.replace("/", "_") + "-" + uniq;

                XposedBridge.log("Capturing " + dexPath);
                XposedBridge.log("Writing to " + outDir);

                InputStream in = new FileInputStream(dexPath);
                OutputStream out = new FileOutputStream(outDir);
                byte[] buf = new byte[1024];
                int len;
                while ((len = in.read(buf)) > 0) {
                    out.write(buf, 0, len);
                }
                in.close();
                out.close();
            }

            @Override
            protected void afterHookedMethod(XC_MethodHook.MethodHookParam param) throws Throwable {

            }
        });

        //I forgot some silly packers load one class at a time using DexFile
        findAndHookMethod("dalvik.system.DexFile", lpparam.classLoader, "openDexFile", String.class, String.class, int.class, new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                String outDir = baseDir;
                String dexPath = (String) param.args[0];

                //Ignore loading of files from /system, comment this out if you wish
                if (dexPath.startsWith("/system/"))
                    return;

                XposedBridge.log("Hooking dalvik.system.DexFile for " + packageName);
                String uniq = UUID.randomUUID().toString();
                outDir = outDir + "/" + packageName  + dexPath.replace("/", "_") + "-" + uniq;

                XposedBridge.log("Capturing " + dexPath);
                XposedBridge.log("Writing to " + outDir);

                InputStream in = new FileInputStream(dexPath);
                OutputStream out = new FileOutputStream(outDir);
                byte[] buf = new byte[1024];
                int len;
                while ((len = in.read(buf)) > 0) {
                    out.write(buf, 0, len);
                }
                in.close();
                out.close();
            }

        });


    }
}
